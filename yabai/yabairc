#!/usr/bin/env sh

#
# for this to work you must configure sudo such that
# it will be able to run the command without password
#
# see this wiki page for information:
#  - https://github.com/koekeishiya/yabai/wiki/Installing-yabai-(latest-release)#configure-scripting-addition
#
# yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"
# sudo yabai --load-sa
#

# global settings
yabai -m config                                 \
    external_bar                 all:40:0       \
    menubar_opacity              1.0            \
    display_arrangement_order    default        \
    window_shadow                on             \
    window_opacity               off            \
    window_origin_display        default        \
    active_window_opacity        1.0            \
    normal_window_opacity        0.80           \
    window_placement             second_child   \
    window_zoom_persist          on             \
    window_animation_duration    0.5            \
    window_animation_easing      ease_out_circ  \
    window_opacity_duration      0.2            \
    insert_feedback_color        0xff9dd274     \
    split_ratio                  0.75           \
    split_type                   auto           \
    auto_balance                 off             \
    top_padding                  30             \
    bottom_padding               30             \
    left_padding                 25             \
    right_padding                25             \
    window_gap                   10             \
    layout                       bsp            \
    mouse_modifier               alt            \
    mouse_action1                move           \
    mouse_action2                resize         \
    mouse_follows_focus          off            \
    focus_follows_mouse          off            \
    mouse_drop_action            swap


# ===== 规则 ==================================
# 定义需要管理的应用规则
declare -A APP_RULES=(
    ["^(LuLu|Calculator|SoftwareUpdate|Dictionary|VLC|System Preferences|System Settings|zoom.us|Photo Booth|Archive Utility|Python|LibreOffice|App Store|Steam|Alfred|Activity Monitor)$"]="off"
    ["^Finder$"]="off"
    ["^Safari$"]="off"
    ["System Information"]="off"
    ["^Inkscape$"]="off"
    ["^飞书$"]="sticky=on layer=above manage=off"
    ["^Feishu$"]="sticky=on layer=above manage=off"
    ["^Lark$"]="sticky=on layer=above manage=off"
    ["^Lark Meetings$"]="sticky=on layer=above manage=off"
    ["^Seal$"]="sticky=on layer=above manage=off"
    ["^AppCleaner$"]="sticky=off layer=above manage=off"
    ["^Karabiner-Elements$"]="sticky=on layer=above manage=off"
    ["^Karabiner-EventViewer$"]="sticky=on layer=above manage=off"
    ["^WeChat$"]="off"
    ["^微信$"]="off"
    ["^Clash for Windows$"]="off"
    ["Dash"]="off"
    ["^WeCom$"]="off"
    ["^企业微信$"]="off"
    ["^BaiduIM$"]="off"
    ["^Pieces$"]="off"
    ["^Loopback$"]="off"
    ["^钉钉$"]="off"
    ["^DingTalk$"]="off"
    ["^(Tencent Lemon)$"]="off"
    ["^(Bandizip)$"]="off"
)

# 应用规则
for app in "${!APP_RULES[@]}"; do
    manage_option=${APP_RULES[$app]}
    yabai -m rule --add app="$app" manage="$manage_option"
done

# 需要浮动的通用窗口标题
FLOAT_TITLES=(
    "Settings"
    "Add File to Git"
    "Delete"
    "Deployment"
    "New Project"
    "Create New Branch"
    "Create Class"
    "Project Structure"
    "Run Target"
    "Run/Debug Configurations"
    "Data Sources and Drivers"
    "Rename"
    "File Cache Conflict"
    "Push Commits to .*"
    "Create Run Configuration: .*"
    "Local History: .*"
    "Commit Changes"
    "Update Project"
    "Merge Branches"
    "Rebase Branches"
    "Find in Path"
    "Replace in Path"
    "Diff"
    "Version Control"
    "Create Gist"
)

# 配置 IDE 函数
configure_ide() {
    local app_name="$1"

    # 设置 IDE 主窗口为非浮动
    yabai -m rule --add app="^${app_name}$" manage=on

    # 设置特定标题的窗口为浮动
    for title in "${FLOAT_TITLES[@]}"; do
        yabai -m rule --add app="^${app_name}$" title="^${title}$" manage=off
    done
}

# 配置各个 IDE
IDE_APPS=(
    "GoLand"
    "IntelliJ IDEA"
    "IntelliJ IDEA-EAP"
    "WebStorm"
    "PhpStorm"
    "RustRover"
)

# 批量配置 IDE
for ide in "${IDE_APPS[@]}"; do
    configure_ide "$ide"
done
